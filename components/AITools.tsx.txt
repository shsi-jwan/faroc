import React, { useState, useRef, useEffect } from 'react';
import { createChatSession, sendMessageStream, generateImage, editImage } from '../services/geminiService';
import { ChatMessage, Language } from '../types';
import { GoogleGenAI } from '@google/genai';

// --- Chat Bot Component ---
export const AIChatBot: React.FC<{ lang: Language }> = ({ lang }) => {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  
  const chatSession = useRef(createChatSession(
    "You are a helpful, professional AI consultant for the ROC Free & Easy Entrepreneurship Association. Provide advice on startups, business strategy, and funding in Taiwan."
  ));

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(scrollToBottom, [messages]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userMsg: ChatMessage = { id: Date.now().toString(), role: 'user', text: input };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsLoading(true);

    try {
      const stream = await sendMessageStream(chatSession.current, userMsg.text);
      
      const modelMsgId = (Date.now() + 1).toString();
      setMessages(prev => [...prev, { id: modelMsgId, role: 'model', text: '' }]);

      for await (const chunk of stream) {
        const text = (chunk as any).text; 
        setMessages(prev => prev.map(msg => 
          msg.id === modelMsgId ? { ...msg, text: msg.text + (text || '') } : msg
        ));
      }
    } catch (error) {
      console.error(error);
      setMessages(prev => [...prev, { id: Date.now().toString(), role: 'model', text: 'Sorry, I encountered an error.', isError: true }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden flex flex-col h-[600px]">
      <div className="bg-slate-900 text-white p-4">
        <h3 className="font-bold text-lg flex items-center gap-2">
          <span className="material-icons">smart_toy</span> 
          {lang === Language.ZH ? 'AI 創業顧問' : 'AI Startup Consultant'}
        </h3>
      </div>
      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
        {messages.length === 0 && (
          <div className="text-center text-slate-400 mt-20">
            <p>{lang === Language.ZH ? '請隨時詢問任何關於創業的問題。' : 'Feel free to ask any questions about entrepreneurship.'}</p>
          </div>
        )}
        {messages.map(msg => (
          <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[80%] rounded-2xl p-4 ${
              msg.role === 'user' 
                ? 'bg-brand-600 text-white rounded-br-none' 
                : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none shadow-sm'
            }`}>
              {msg.text}
            </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
             <div className="bg-white border border-slate-200 text-slate-500 rounded-2xl p-4 rounded-bl-none shadow-sm animate-pulse">
               Thinking...
             </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>
      <form onSubmit={handleSubmit} className="p-4 bg-white border-t border-slate-100 flex gap-2">
        <input
          type="text"
          value={input}
          onChange={e => setInput(e.target.value)}
          placeholder={lang === Language.ZH ? "輸入您的問題..." : "Type your question..."}
          className="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-all"
        />
        <button 
          type="submit" 
          disabled={isLoading}
          className="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-lg font-medium disabled:opacity-50 transition-colors"
        >
          {lang === Language.ZH ? '發送' : 'Send'}
        </button>
      </form>
    </div>
  );
};

// --- Image Generation Component ---
export const AIImageGen: React.FC<{ lang: Language }> = ({ lang }) => {
  const [prompt, setPrompt] = useState('');
  const [size, setSize] = useState<'1K' | '2K' | '4K'>('1K');
  const [result, setResult] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleGenerate = async () => {
    if (!prompt) return;
    setLoading(true);
    setError(null);
    setResult(null);
    try {
      const img = await generateImage(prompt, size);
      setResult(img);
    } catch (err) {
      setError(lang === Language.ZH ? "生成失敗，請稍後再試。" : "Generation failed. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
      <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
        <h3 className="text-xl font-bold mb-2">
           {lang === Language.ZH ? 'Nano Banana Pro 圖像生成' : 'Nano Banana Pro Image Gen'}
        </h3>
        <p className="opacity-80">
          {lang === Language.ZH ? '使用最先進的 Gemini 3 Pro 模型生成高品質圖像。' : 'Generate high-quality images using the state-of-the-art Gemini 3 Pro model.'}
        </p>
      </div>
      <div className="p-6 space-y-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">
            {lang === Language.ZH ? '解析度' : 'Resolution'}
          </label>
          <div className="flex gap-4">
            {['1K', '2K', '4K'].map((s) => (
              <label key={s} className="flex items-center gap-2 cursor-pointer">
                <input 
                  type="radio" 
                  name="size" 
                  value={s} 
                  checked={size === s} 
                  onChange={() => setSize(s as any)}
                  className="text-brand-600 focus:ring-brand-500"
                />
                <span className="text-sm font-medium">{s}</span>
              </label>
            ))}
          </div>
        </div>
        <div>
           <label className="block text-sm font-medium text-slate-700 mb-1">
            {lang === Language.ZH ? '提示詞' : 'Prompt'}
          </label>
          <textarea
            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none h-32 resize-none"
            placeholder={lang === Language.ZH ? "描述您想看到的圖像..." : "Describe the image you want to see..."}
            value={prompt}
            onChange={e => setPrompt(e.target.value)}
          />
        </div>
        <button
          onClick={handleGenerate}
          disabled={loading || !prompt}
          className="w-full bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-lg font-bold transition-all disabled:opacity-50"
        >
          {loading ? (lang === Language.ZH ? '生成中...' : 'Generating...') : (lang === Language.ZH ? '開始生成' : 'Generate')}
        </button>
        
        {error && <div className="text-red-500 bg-red-50 p-3 rounded-lg text-sm">{error}</div>}
        
        {result && (
          <div className="mt-6">
            <p className="text-sm font-medium text-slate-500 mb-2">{lang === Language.ZH ? '生成結果：' : 'Result:'}</p>
            <img src={result} alt="Generated" className="w-full rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300" />
            <a href={result} download="generated-image.png" className="block text-center text-brand-600 mt-2 hover:underline text-sm">Download</a>
          </div>
        )}
      </div>
    </div>
  );
};

// --- Image Editing Component ---
export const AIImageEdit: React.FC<{ lang: Language }> = ({ lang }) => {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [preview, setPreview] = useState<string | null>(null);
  const [prompt, setPrompt] = useState('');
  const [result, setResult] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      setSelectedFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setPreview(reader.result as string);
      reader.readAsDataURL(file);
      setResult(null);
    }
  };

  const handleEdit = async () => {
    if (!preview || !prompt) return;
    setLoading(true);
    setResult(null);

    try {
      const edited = await editImage(preview, prompt, selectedFile?.type);
      setResult(edited);
    } catch (e) {
      alert("Editing failed");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
       <div className="bg-gradient-to-r from-pink-600 to-rose-600 p-6 text-white">
        <h3 className="text-xl font-bold mb-2">
           {lang === Language.ZH ? 'Nano Banana 圖像編輯' : 'Nano Banana Image Editor'}
        </h3>
        <p className="opacity-80">
          {lang === Language.ZH ? '上傳並使用文字指令修改圖像 (Gemini 2.5 Flash)。' : 'Upload and edit images using text commands (Gemini 2.5 Flash).'}
        </p>
      </div>
      
      <div className="p-6 space-y-6">
        <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors">
          <input type="file" onChange={handleFileChange} className="hidden" id="file-upload" accept="image/*" />
          <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center">
            {preview ? (
               <img src={preview} alt="Original" className="max-h-64 rounded shadow-sm object-contain" />
            ) : (
              <>
                <svg className="w-12 h-12 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span className="text-brand-600 font-medium">{lang === Language.ZH ? '點擊上傳圖片' : 'Click to upload image'}</span>
              </>
            )}
          </label>
        </div>

        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">
             {lang === Language.ZH ? '編輯指令' : 'Editing Instruction'}
          </label>
          <div className="flex gap-2">
            <input
              type="text"
              className="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none"
              placeholder={lang === Language.ZH ? "例如：加入復古濾鏡..." : "e.g., Add a retro filter..."}
              value={prompt}
              onChange={e => setPrompt(e.target.value)}
            />
            <button
              onClick={handleEdit}
              disabled={loading || !preview || !prompt}
              className="bg-brand-600 hover:bg-brand-700 text-white px-6 rounded-lg font-bold disabled:opacity-50"
            >
              {loading ? '...' : (lang === Language.ZH ? '編輯' : 'Edit')}
            </button>
          </div>
        </div>

        {result && (
           <div className="mt-6 border-t pt-6 animate-fade-in">
             <h4 className="font-bold text-slate-800 mb-4">{lang === Language.ZH ? '編輯結果' : 'Edited Result'}</h4>
             <img src={result} alt="Edited" className="w-full rounded-lg shadow-xl" />
           </div>
        )}
      </div>
    </div>
  );
};